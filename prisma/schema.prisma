generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===================================
// ENUMS
// ===================================

enum TemplateType {
  profile_template
  content_block
}

enum OperationMode {
  Comercial
  RedeApoio
  Hibrido
}

enum SubscriptionType {
  Recorrente
  Contrato
}

enum BillingCycle {
  Monthly
  Semiannual
  Yearly
  OneTime
}

enum SubscriptionStatus {
  Active
  Paused
  Cancelled
  Expired
}

enum AddressType {
  comercial
  residencial
}

// ===================================
// MODELOS DE AUTENTICAÇÃO E CORE
// ===================================

model User {
  id                   String            @id @default(cuid())
  supabaseUserId       String?           @unique @map("supabase_user_id")
  name                 String?
  email                String?           @unique
  emailVerified        DateTime?
  image                String?
  cargo                String?           // Cargo/função do usuário
  celular              String?           // Telefone celular
  deletedAt            DateTime?
  adminRoleId          String?
  adminRole            AdminRole?        @relation(fields: [adminRoleId], references: [id])
  workspacesOwned      Workspace[]       @relation("WorkspaceOwner")
  workspaceMemberships WorkspaceMember[]
  createdTemplates     DigitalTemplate[] @relation("TemplateCreator")
  digitalProfiles      DigitalProfile[]
  createdAddresses     Address[]
  adminOfUnits         Unit[]            @relation("UnitAdmin")
  unitMemberships      UnitMember[]
  preferences          Json?             // Stores user UI preferences: theme, language, timezone, dateFormat, timeFormat, highContrast, twoFactorMethod
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
}

model AdminRole {
  id    String @id @default(cuid())
  name  String @unique // 'super_admin', 'admin', 'manager'
  users User[]
}

model WorkspaceRole {
  id      String            @id @default(cuid())
  name    String            @unique // 'work_admin', 'work_manager', 'work_user'
  members WorkspaceMember[]
}

model Organization {
  id          String   @id @default(cuid())
  name        String
  document    String?  @unique

  // Relação com Workspaces que pertencem a esta Organização
  workspaces Workspace[]

  // Relação com o Endereço de Cobrança
  billingAddressId String?
  billingAddress   Address? @relation("OrganizationBilling", fields: [billingAddressId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([document])
}


model Workspace {
  id        String            @id @default(cuid())
  name      String
  slug      String            @unique
  ownerId   String
  owner     User              @relation("WorkspaceOwner", fields: [ownerId], references: [id])
  members   WorkspaceMember[]
  
  // Relação com Organização (empresa cliente)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  // --- CAMPOS DO STRIPE ---
  stripeCustomerId       String?   @unique @map("stripe_customer_id")
  stripeSubscriptionId   String?   @unique @map("stripe_subscription_id")
  stripePriceId          String?   @map("stripe_price_id")
  stripeCurrentPeriodEnd DateTime? @map("stripe_current_period_end")

  // Relações com todos os módulos
  units            Unit[]
  addresses        Address[]
  contacts         Contact[]
  tasks            Task[]
  projects         Project[]
  digitalTemplates DigitalTemplate[]
  digitalProfiles  DigitalProfile[]
  campaigns        Campaign[]
  aiAssistants     AiAssistant[]
  reports          Report[]
  portfolios       Portfolio[]
  events           Event[]
  automations      Automation[]
  reviews          Review[]
  
  // Relação com assinatura de plano
  subscription WorkspaceSubscription?
  
  @@index([organizationId])
}

model WorkspaceMember {
  id              String        @id @default(cuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id])
  workspaceId     String
  workspace       Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  workspaceRoleId String
  workspaceRole   WorkspaceRole @relation(fields: [workspaceRoleId], references: [id])
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([userId, workspaceId])
}

model Address {
  id          String   @id @default(cuid())
  name        String   // Nome interno para o endereço
  label       String?  // Ex: "Matriz", "Filial"

  street      String
  number      String
  complement  String?
  district    String
  city        String
  stateCode   String   // UF de 2 letras
  country     String
  postalCode  String

  latitude    Float?
  longitude   Float?
  // Para buscas geoespaciais avançadas (requer PostGIS no PostgreSQL)
  // Ex: GEOGRAPHY(Point, 4326)
  // geoPoint    Unsupported("geography(Point, 4326)")?

  type        AddressType // Enum: 'comercial', 'residencial'
  isActive    Boolean  @default(true)

  // Relação Multi-Tenant
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Relação com o criador
  createdById String
  createdBy   User      @relation(fields: [createdById], references: [id])
  units       Unit[]

  // Relação inversa para Organization (endereço de cobrança)
  organizationBilling Organization[] @relation("OrganizationBilling")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workspaceId])
}



model Unit {
  id          String   @id @default(cuid())
  name        String
  description String?

  isActive    Boolean  @default(true)

  // Relação Multi-Tenant (a qual Workspace a Unidade pertence)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Relação com o Template
  templateId  String?
  template    DigitalTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  // Relação com o Endereço
  addressId   String?
  address     Address? @relation(fields: [addressId], references: [id], onDelete: SetNull)

  // Relação com o Usuário Admin da Unidade
  unitAdminId String?
  unitAdmin   User?    @relation("UnitAdmin", fields: [unitAdminId], references: [id], onDelete: SetNull)

  // Relação com os membros da Unidade (um para muitos)
  members     UnitMember[]

  // O campo 'Users Actives' será calculado dinamicamente com uma query (ex: prisma.unitMember.count(...))
  // e não armazenado aqui para evitar inconsistência de dados.

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([workspaceId])
}

model UnitMember {
  id     String @id @default(cuid())
  
  unitId String
  unit   Unit   @relation(fields: [unitId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([unitId, userId])
}

// ===================================
// MODELOS DE TEMPLATES DIGITAIS
// ===================================

model DigitalTemplate {
  id              String            @id @default(cuid())
  name            String
  description     String?
  type            TemplateType
  content         Json
  workspaceId     String?           @map("workspace_id")
  workspace       Workspace?        @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  createdByUserId String
  createdByUser   User              @relation("TemplateCreator", fields: [createdByUserId], references: [id], onDelete: Cascade)
  usedInProfiles  DigitalProfile[]
  units           Unit[]
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([createdByUserId])
  @@index([workspaceId])
}

// ===================================
// MODELOS DE MÓDULOS (Placeholders)
// ===================================

// CRM
model Contact {
  id          String    @id @default(cuid())
  fullName    String
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// Tasks
model Task {
  id          String    @id @default(cuid())
  title       String
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// Projects
model Project {
  id          String    @id @default(cuid())
  name        String
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// Digital Profiles
model DigitalProfile {
  id               String           @id @default(cuid())
  name             String
  workspaceId      String
  workspace        Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  userId           String
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  sourceTemplateId String?
  sourceTemplate   DigitalTemplate? @relation(fields: [sourceTemplateId], references: [id], onDelete: SetNull)
  content          Json
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@index([workspaceId])
  @@index([userId])
  @@index([sourceTemplateId])
}

// Campaigns
model Campaign {
  id           String    @id @default(cuid())
  campaignName String
  workspaceId  String
  workspace    Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

// AI Assistants
model AiAssistant {
  id            String    @id @default(cuid())
  assistantName String
  workspaceId   String
  workspace     Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// Reports
model Report {
  id          String    @id @default(cuid())
  reportName  String
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// Portfolio
model Portfolio {
  id            String    @id @default(cuid())
  portfolioName String
  workspaceId   String
  workspace     Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// Events (renomeado para evitar conflito com palavra-chave SQL)
model Event {
  id          String    @id @default(cuid())
  eventName   String
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// Automations
model Automation {
  id             String    @id @default(cuid())
  automationName String
  workspaceId    String
  workspace      Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

// Reviews
model Review {
  id          String    @id @default(cuid())
  reviewText  String
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// ===================================
// PLANOS E ASSINATURAS
// ===================================

// Plan: Catálogo de planos oferecidos pela plataforma
// Define os diferentes níveis de serviço disponíveis
model Plan {
  id               String                    @id @default(cuid())
  name             String                    // Nome do plano (ex: "Profissional")
  description      String?                   // Descrição opcional
  operationMode    OperationMode             // Modo de operação (Comercial, RedeApoio, Hibrido)
  subscriptionType SubscriptionType          // Tipo de assinatura (Trial, Basic, Professional, Enterprise)
  billingCycle     BillingCycle?             // Ciclo de faturamento (Monthly, Quarterly, Yearly)
  price            Decimal                   // Preço em decimal (ex: 99.90)
  userLimit        Int                       // Limite máximo de usuários
  features         Json                      // Array de features em JSON (armazenado como array de strings)
  isActive         Boolean                   @default(true)
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime                  @updatedAt

  // Relações
  subscriptions WorkspaceSubscription[] @relation("PlanSubscriptions")

  @@index([isActive])
}

// WorkspaceSubscription: Vincula um Workspace a um Plan
// Representa a assinatura de um workspace a um plano específico
model WorkspaceSubscription {
  id                   String               @id @default(cuid())
  workspaceId          String               @unique // Um workspace por assinatura (relação 1:1)
  workspace            Workspace            @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  planId               String
  plan                 Plan                 @relation("PlanSubscriptions", fields: [planId], references: [id])
  status               SubscriptionStatus   @default(Active)
  stripeSubscriptionId String?              // ID da assinatura no Stripe (para integração de pagamento)
  startDate            DateTime             @default(now())
  endDate              DateTime?            // Data de término (null = sem fim determinado)
  renewalDate          DateTime?            // Próxima data de renovação automática
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt

  @@index([workspaceId])
  @@index([planId])
  @@index([status])
}

// Planning
